---
variables:
  - name: Codeql.Enabled
    value: true
trigger:
  branches:
    include:
      - "*"
  paths:
    include:
      - pipelines/**
      - src/apisof.net/**
      - src/Terrajobst.ApiCatalog/**
    exclude:
      - .gitignore
      - .github/*
  batch: true
name: $(date:yyyyMMdd)$(rev:.r)
resources:
  repositories:
    - repository: self
      type: git
      ref: main
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    sdl:
      sourceAnalysisPool:
        name: AzurePipelines-EO
        image: 1ESPT-Windows2022 # Name of the image in your pool. If not specified, first image of the pool is used
        os: windows # OS of the image. Allowed values: windows, linux, macOS
    pool:
      name: AzurePipelines-EO
      image: 1ESPT-Ubuntu22.04
      os: linux
    stages:
      - stage: stage
        jobs:
          - job: Phase_1
            displayName: Agent job 1
            timeoutInMinutes: 0
            templateContext:
              outputs:
                - output: pipelineArtifact
                  displayName: "Publish Artifact"
                  targetPath: $(build.artifactstagingdirectory)
                  artifactName: apis-of-dotnet-drop
            steps:
              - checkout: self
                fetchDepth: 0
              - task: UseDotNet@2
                displayName: Use .NET 8 SDK
                inputs:
                  version: 8.x
                  includePreviewVersions: true
              - task: NuGetAuthenticate@1
                displayName: "NuGet Authenticate"
              - script: |
                  cd src/apisof.net
                  dotnet clean
                  dotnet restore
                  dotnet publish apisof.net.csproj -r linux-x64 --self-contained false -o "$(build.artifactstagingdirectory)" /p:SourceRevisionId=$(Build.SourceVersion)
                displayName: "Publish Web Application"
              - script: |
                  sourcePath="$(build.artifactstagingdirectory)/apisof.net.zip"
                  targetPath="$(build.artifactstagingdirectory)/site.zip"
                  if [ -f "$sourcePath" ]; then
                    mv "$sourcePath" "$targetPath"
                    echo "Successfully renamed apisof.net.zip to site.zip"
                  else
                    echo "Warning: Source file not found: $sourcePath"
                  fi
                displayName: "Rename package to site.zip"
