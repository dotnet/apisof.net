---
steps:
  - checkout: self
  - task: UseDotNet@2
    displayName: Use .NET 8 SDK
    inputs:
      version: 8.x
      includePreviewVersions: true
  - task: NuGetAuthenticate@1
    displayName: "NuGet Authenticate"
  - script: |
      dotnet build "$(Build.SourcesDirectory)/src/GenUsageNuGet/GenUsageNuGet.csproj" --configuration $(BuildConfiguration)
    displayName: "Build GenUsageNuGet"
  - task: AzureCLI@2
    displayName: "Run GenUsageNuGet"
    inputs:
      azureSubscription: "$(AzureSubscriptionConnection)"
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        echo "OIDC Token File: ${AZURE_FEDERATED_TOKEN_FILE:-<not set>}"

        if [ -n "$AZURE_FEDERATED_TOKEN_FILE" ] && [ -f "$AZURE_FEDERATED_TOKEN_FILE" ]; then
          echo "----- RAW TOKEN -----"
          cat "$AZURE_FEDERATED_TOKEN_FILE"

          echo "----- DECODED PAYLOAD -----"
          cut -d '.' -f2 "$AZURE_FEDERATED_TOKEN_FILE" | base64 -d | jq
        else
          echo "No OIDC token file available (not using workload identity)."
        fi
    env:
      AzureStorageServiceUrl: $(AzureStorageServiceUrl)
      ApisOfDotNetWebHookSecret: $(ApisOfDotNetWebHookSecret)